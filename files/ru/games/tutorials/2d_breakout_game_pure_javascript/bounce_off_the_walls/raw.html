<div>{{GamesSidebar}}</div>

<div>{{IncludeSubnav("/en-US/docs/Games")}}</div>

<p>{{PreviousNext("Games/Tutorials/2D_Breakout_game_pure_JavaScript/Переместить_мяч", "Games/Tutorials/2D_Breakout_game_pure_JavaScript/Paddle_and_keyboard_controls")}}</p>

<div class="summary">
<p>Это 3-й этап из 10  <a href="https://developer.mozilla.org/en-US/docs/Games/Workflows/Breakout_game_from_scratch">Gamedev Canvas tutorial</a>. Вы можете найти исходный код как он должен выглядеть после завершения этого урока в <a href="https://github.com/end3r/Gamedev-Canvas-workshop/blob/gh-pages/lesson03.html">Gamedev-Canvas-workshop/lesson3.html</a>.</p>
</div>

<p>Приятно видеть наш мяч, но он быстро исчезает с экрана, небольшое удовольствие мы получили с ним! Чтобы продлить это, мы реализуем некоторое очень простое обнаруженийе столкновений (о которых будет рассказано <a href="https://developer.mozilla.org/en-US/docs/Games/Workflows/Breakout_game_from_scratch/Collision_detection">далее</a> более подробно), чтобы сделать отскок мяча от четырех краев холста.</p>

<h2 id="Простое_обнаружение_столкновений">Простое обнаружение столкновений</h2>

<p>Для обнаружения столкновения мы будем проверять -  мяч касается (сталкивается) стены, и если это так, мы изменим направление своего движения соответственно.</p>

<p>Чтобы сделать расчеты проще, давайте определим переменную <code>ballRadius</code>, что задаст радиус нарисованного круга и использоваться для вычислений. Добавьте это в ваш код, где-то ниже существующих переменных:</p>

<pre class="brush: js">var ballRadius = 10;</pre>

<p>Теперь обновить строку, которая рисует шарик внутри функции <code>drawBall() </code>:</p>

<pre class="brush: js">ctx.arc(x, y, ballRadius, 0, Math.PI*2);</pre>

<h3 id="Отскакивание_от_верхней_и_нижней_стены">Отскакивание от верхней и нижней стены</h3>

<p>Есть четыре стены, чтобы отпрыгнул мяч — давайте сосредоточимся на верхний первой. Нужно проверить, на каждый кадр, коснулся мяч верхнего края холста — если да, то будет обратное движение мяча, поэтому он начнет двигаться в противоположном направлении и остановиться в пределах видимой границы. Вспомнив, что система координат начинается с левого верхнего угла, мы можем придумать что-то вроде этого:</p>

<pre class="brush: js">if(y + dy &lt; 0) {
    dy = -dy;
}</pre>

<p>Если значение <code>y</code> положения шара ниже нуля, изменить направление движения по оси <font face="consolas, Liberation Mono, courier, monospace"><span style="background-color: rgba(220, 220, 220, 0.5);">y</span></font> установив его с тем же значением но с другим знаком. Если мяч движется вверх со скоростью 2 пикселов на кадр, теперь он будет двигаться "вверх" со скоростью -2 пикселей, что на самом деле равно движется вниз со скоростью 2 пикселя в кадре.</p>

<p>Приведенный выше код будет иметь дело с мячом отражаясь от верхнего края, так что теперь давайте думать о нижнем крае:</p>

<pre class="brush: js">if(y + dy &gt; canvas.height) {
    dy = -dy;
}</pre>

<p>Если положение мяча по оси <code>y</code> больше, чем высота полотна (помните, что мы рассчитываем значения <code>y</code> от верхнего левого, чтобы верхний край начинался с 0, а нижний край — 480 пикселей, высота нашего <code>&lt;canvas&gt;</code>), затем с отскоком от нижней кромки обратного хода по оси <code>y</code> движение, как и прежде.</p>

<p>Мы можем объединить эти две конструкции в одну, чтобы сэкономить на коде:</p>

<pre class="brush: js">if(y + dy &gt; canvas.height || y + dy &lt; 0) {
    dy = -dy;
}</pre>

<p>Если одно из двух утверждений верно, тогда изменить направление движения мяча.</p>

<h3 id="Отскоки_влево_и_вправо">Отскоки влево и вправо</h3>

<p>У нас есть верхний и нижний край, давайте подумаем, о левом и правом. Задача очень похожа на самом деле, все, что вам нужно сделать, это повторить конструкцию заменив Y на X:</p>

<pre class="brush: js">if(x + dx &gt; canvas.width || x + dx &lt; 0) {
    dx = -dx;
}

if(y + dy &gt; canvas.height || y + dy &lt; 0) {
    dy = -dy;
}</pre>

<p>На этом этапе вы должны вставить выше блок кода в функцию Draw (), непосредственно перед закрывающей фигурной скобкой.</p>

<h3 id="Мяч_продолжает_исчезать_в_стене!">Мяч продолжает исчезать в стене!</h3>

<p>Проверьте сейчас свой код, и вы будете впечатлены — теперь у нас есть мяч, который отскочил от всех четерёх краёв нашего <code>&lt;canvas&gt;</code>!  Однако у нас есть некоторая проблема - когда мяч попадает в любую стену, он немного заходит за границы <code>&lt;canvas&gt;</code> перед сменой направления движения:</p>

<p><img alt="" src="https://mdn.mozillademos.org/files/10432/ball-in-wall.png" style="display: block; height: 320px; margin: 0px auto; width: 480px;"></p>

<p>Это происходит потому, что мы ищем точки столкновения стены и центра шара, а должны делать это относительно окружности. Мяч должен отскакивать сразу после косания стены, а не когда он уже на половину в стене, так что давайте корректировать наш код включив в него небольшое выражение. Обновите последний код добавив к нему:</p>

<pre class="brush: js">if(x + dx &gt; canvas.width-ballRadius || x + dx &lt; ballRadius) {
    dx = -dx;
}
if(y + dy &gt; canvas.height-ballRadius || y + dy &lt; ballRadius) {
    dy = -dy;
}</pre>

<p>Когда расстояние между центром шара и краем стены точно такое же, как радиус шарика, шар изменит направление движения. Вычитая радиус с одной кромки по ширине и добавить его на другую дает нам впечатление правильного обнаружения столкновения. Шарик отскакивает от стен, как это и должено быть.</p>

<h2 id="Сравните_ваш_код">Сравните ваш код</h2>

<p>Давайте еще раз провериим готовый код для этой части, и код, что у вас есть, и играйте:</p>

<p>{{JSFiddleEmbed("https://jsfiddle.net/end3r/redj37dc/","","370")}}</p>

<div class="note">
<p><strong>Упражнение: </strong>попробуйте изменить цвет шарика на случайный цвет каждый раз, когда он попадает в стену.</p>
</div>

<h2 id="Следующий_шаг">Следующий шаг</h2>

<p>Теперь мы добрались до стадии, где наш мяч одновременно двигается и остаётся на игровом поле. В четвертой главе мы рассмотрим реализацию управляния — см. <a href="https://developer.mozilla.org/en-US/docs/Games/Workflows/Breakout_game_from_scratch/Paddle_and_keyboard_controls">Paddle and keyboard controls</a>.</p>

<p>{{PreviousNext("Games/Workflows/2D_Breakout_game_pure_JavaScript/Move_the_ball", "Games/Workflows/2D_Breakout_game_pure_JavaScript/Paddle_and_keyboard_controls")}}</p>